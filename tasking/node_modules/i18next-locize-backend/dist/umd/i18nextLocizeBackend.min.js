!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).i18nextLocizeBackend=t()}(this,(function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function n(e,t,n){var o;return function(){var i=this,r=arguments,s=function(){o=null,n||e.apply(i,r)},a=n&&!o;clearTimeout(o),o=setTimeout(s,t),a&&e.apply(i,r)}}function o(e,t,n){function o(e){return e&&e.indexOf("###")>-1?e.replace(/###/g,"."):e}for(var i="string"!=typeof t?[].concat(t):t.split(".");i.length>1;){if(!e)return{};var r=o(i.shift());!e[r]&&n&&(e[r]=new n),e=e[r]}return e?{obj:e,k:o(i.shift())}:{}}function i(e,t,n){var i=o(e,t,Object);i.obj[i.k]=n}function r(e,t){var n=o(e,t),i=n.obj,r=n.k;if(i)return i[r]}var s=new RegExp("{{(.+?)}}","g");function a(e,t,n){var o,i,r;for(;o=s.exec(e);)"string"!=typeof(i=o[1].trim())&&(i=null==(r=i)?"":""+r),i||(i=""),i=i.replace(/\$/g,"$$$$"),e=e.replace(o[0],t[i]||i),s.lastIndex=0;return e}function c(e,t){return t.reduce((function(t,n){if(t)return t;if(!e||!e[n]||"string"!=typeof e[n]||!e[n].toLowerCase()===n.toLowerCase()){var o='i18next-locize-backend :: got "'.concat(e[n],'" in options for ').concat(n," which is invalid.");return console.warn(o),o}return!1}),!1)}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function u(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?l(Object(o),!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):l(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function p(e,t,n,o,i){try{var r=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");r.open(o?"POST":"GET",e,1),t.crossDomain||r.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.authorize&&t.apiKey&&r.setRequestHeader("Authorization",t.apiKey),(o||t.setContentTypeJSON)&&r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){r.readyState>3&&n&&n(r.responseText,r)},r.send(JSON.stringify(o))}catch(e){"undefined"!=typeof window&&window.console&&console.log(e)}}var d=function(){function e(t,n,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t&&t.projectId?this.init(null,t,{},n):this.init(null,n,{},o),this.type="backend"}var s,l,d;return s=e,(l=[{key:"init",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;this.options=u({},{loadPath:"https://api.locize.io/{{projectId}}/{{version}}/{{lng}}/{{ns}}",privatePath:"https://api.locize.io/private/{{projectId}}/{{version}}/{{lng}}/{{ns}}",pullPath:"https://api.locize.io/pull/{{projectId}}/{{version}}/{{lng}}/{{ns}}",getLanguagesPath:"https://api.locize.io/languages/{{projectId}}",addPath:"https://api.locize.io/missing/{{projectId}}/{{version}}/{{lng}}/{{ns}}",updatePath:"https://api.locize.io/update/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",pull:!1,private:!1,whitelistThreshold:.9,failLoadingOnEmptyJSON:!1,allowedAddOrUpdateHosts:["localhost"],onSaved:!1},{},this.options,{},o),this.services=e,this.options.pull&&console.warn("deprecated: pull will be removed in future versions and should be replaced with locize private versions");var s="undefined"!=typeof window&&window.location&&window.location.hostname;s?(this.isAddOrUpdateAllowed="function"==typeof this.options.allowedAddOrUpdateHosts?this.options.allowedAddOrUpdateHosts(s):this.options.allowedAddOrUpdateHosts.indexOf(s)>-1,i.saveMissing&&!this.isAddOrUpdateAllowed&&e&&e.logger&&e.logger.warn('locize-backend: will not save missings because the host "'.concat(s,'" was not in the list of allowedAddOrUpdateHosts: ').concat(this.options.allowedAddOrUpdateHosts.join(", ")," (matches need to be exact)."))):this.isAddOrUpdateAllowed=!0,"function"==typeof r&&this.getOptions((function(e,n){if(e)return r(e);t.options.referenceLng=o.referenceLng||n.referenceLng||t.options.referenceLng,r(null,n)})),this.queuedWrites={},this.debouncedProcess=n(this.process,1e4)}},{key:"getLanguages",value:function(e){var t=c(this.options,["projectId"]);if(t)return e(new Error(t));var n=a(this.options.getLanguagesPath,{projectId:this.options.projectId});this.loadUrl(n,{},e)}},{key:"getOptions",value:function(e){var t=this;this.getLanguages((function(n,o){if(n)return e(n);var i=Object.keys(o);if(!i.length)return e(new Error("was unable to load languages via API"));var r=i.reduce((function(e,t){return o[t].isReferenceLanguage&&(e=t),e}),""),s=i.reduce((function(e,n){var i=o[n];return i.translated[t.options.version]&&i.translated[t.options.version]>=t.options.whitelistThreshold&&e.push(n),e}),[]),a=i.reduce((function(e,t){return t.indexOf("-")>-1||e}),!1);e(null,{fallbackLng:r,referenceLng:r,whitelist:s,load:a?"all":"languageOnly"})}))}},{key:"read",value:function(e,t,n){var o,i={};if(this.options.private){var r=c(this.options,["projectId","version","apiKey"]);if(r)return n(new Error(r),!1);o=a(this.options.privatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}}else if(this.options.pull){var s=c(this.options,["projectId","version","apiKey"]);if(s)return n(new Error(s),!1);o=a(this.options.pullPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}}else{var l=c(this.options,["projectId","version"]);if(l)return n(new Error(l),!1);o=a(this.options.loadPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version})}this.loadUrl(o,i,n)}},{key:"loadUrl",value:function(e,t,n){var o=this;p(e,u({},this.options,{},t),(function(t,i){if(i.status>=500&&i.status<600)return n("failed loading "+e,!0);if(i.status>=400&&i.status<500)return n("failed loading "+e,!1);var r,s;try{r=JSON.parse(t)}catch(t){s="failed parsing "+e+" to json"}return s?n(s,!1):o.options.failLoadingOnEmptyJSON&&!Object.keys(r).length?n("loaded result empty for "+e,!1):void n(null,r)}))}},{key:"create",value:function(e,t,n,o,i,r){var s=this;i||(i=function(){});var a=c(this.options,["projectId","version","apiKey","referenceLng"]);return a?i(new Error(a)):this.isAddOrUpdateAllowed?("string"==typeof e&&(e=[e]),e.filter((function(e){return e===s.options.referenceLng})).length<1&&this.services&&this.services.logger&&this.services.logger.warn('locize-backend: will not save missings because the reference language "'.concat(this.options.referenceLng,'" was not in the list of to save languages: ').concat(e.join(", ")," (open your site in the reference language to save missings).")),void e.forEach((function(e){e===s.options.referenceLng&&s.queue.call(s,s.options.referenceLng,t,n,o,i,r)}))):i("host is not allowed to create key.")}},{key:"update",value:function(e,t,n,o,i,r){var s=this;i||(i=function(){});var a=c(this.options,["projectId","version","apiKey","referenceLng"]);return a?i(new Error(a)):this.isAddOrUpdateAllowed?(r||(r={}),"string"==typeof e&&(e=[e]),r.isUpdate=!0,void e.forEach((function(e){e===s.options.referenceLng&&s.queue.call(s,s.options.referenceLng,t,n,o,i,r)}))):i("host is not allowed to update key.")}},{key:"write",value:function(e,t){var n=this;if(!r(this.queuedWrites,["locks",e,t])){var o=a(this.options.addPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),s=a(this.options.updatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),c=r(this.queuedWrites,[e,t]);if(i(this.queuedWrites,[e,t],[]),c.length){i(this.queuedWrites,["locks",e,t],!0);var l=!1,d=!1,f={},h={};c.forEach((function(e){var t=e.options&&e.options.tDescription?{value:e.fallbackValue||"",context:{text:e.options.tDescription}}:e.fallbackValue||"";e.options&&e.options.isUpdate?(d||(d=!0),h[e.key]=t):(l||(l=!0),f[e.key]=t)}));var v=0;l&&v++,d&&v++;var g=function(){--v||(i(n.queuedWrites,["locks",e,t],!1),c.forEach((function(e){e.callback&&e.callback()})),n.options.onSaved&&n.options.onSaved(e,t),n.debouncedProcess(e,t))};v||g(),l&&p(o,u({},{authorize:!0},{},this.options),(function(e,t){g()}),f),d&&p(s,u({},{authorize:!0},{},this.options),(function(e,t){g()}),h)}}}},{key:"process",value:function(){var e=this;Object.keys(this.queuedWrites).forEach((function(t){"locks"!==t&&Object.keys(e.queuedWrites[t]).forEach((function(n){e.queuedWrites[t][n].length&&e.write(t,n)}))}))}},{key:"queue",value:function(e,t,n,i,r,s){var a,c,l,u,p,d;a=this.queuedWrites,c={key:n,fallbackValue:i||"",callback:r,options:s},u=o(a,[e,t],Object),p=u.obj,d=u.k,p[d]=p[d]||[],l&&(p[d]=p[d].concat(c)),l||p[d].push(c),this.debouncedProcess()}}])&&t(s.prototype,l),d&&t(s,d),e}();return d.type="backend",d}));
